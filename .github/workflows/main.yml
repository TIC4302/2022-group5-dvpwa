name: CI

on:
   push:
     branches: [master]

jobs:
   build:
     runs-on: ubuntu-latest

     steps:
       - uses: actions/checkout@v2

       - name: Build docker-compose
         run: docker-compose -f docker-compose.yml up --build -d
  
   secret-scan:
     runs-on: ubuntu-latest

     steps:
       - uses: actions/checkout@v2

       - run: |
          mkdir -p logs/
          echo 'app/' > logs/exclude.txt
       - uses: max/secret-scan@master
         with:
          exclude_path: 'logs/exclude.txt'

   sca:
     runs-on: ubuntu-latest

     steps:
       - uses: actions/checkout@v2

       - run: mkdir -p logs/

       - name: Pyraider
         run: |
           pip3 install pyraider
           pyraider go > logs/safety.log
       - uses: actions/upload-artifact@v2
         with: 
          name: logs
          path: logs/safety.log

   sast:
     needs: [build, sca]
     runs-on: ubuntu-latest

     steps: 
       - uses: actions/checkout@v2

       - run: mkdir -p logs/

       - uses: jpetrucciani/bandit-check@master
         with: 
           path: '.'
           bandit_flags: '-ll -o logs/bandit.log -f txt'

       - uses: actions/upload-artifact@v2
         with: 
          name: logs
          path: logs/bandit.log
    
   image-scan:
     needs: [sast]
     runs-on: ubuntu-latest

     steps: 
       - name: Run Trivy vulnerability scanner
         uses: aquasecurity/trivy-action@master
         with:
          image-ref: 'docker.io/my-organization/my-app:${{ github.sha }}'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'


