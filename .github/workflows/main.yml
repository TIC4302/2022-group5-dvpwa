name: CI

on:
   push:
     branches: [master]

jobs:
   build:
     runs-on: ubuntu-latest

     steps:
       - uses: actions/checkout@v2

       - name: Build docker-compose
         run: docker-compose -f docker-compose.yml up --build -d
    
   secret-scan:
     needs: [build]
     runs-on: ubuntu-latest

     steps:
       - uses: actions/checkout@v2

       - uses: max/secret-scan@master

   sca:
     needs: [build]
     runs-on: ubuntu-latest

     steps:
       - uses: actions/checkout@v2

       - run: mkdir -p logs/

       - name: Install Safety
         run: pip install safety

       - name: Safety scan
         run: safety check > logs/safety.log
         continue-on-error: true

       - uses: actions/upload-artifact@v2
         with: 
          name: logs
          path: logs/safety.log

   sast:
     needs: [build]
     runs-on: ubuntu-latest

     steps: 
       - uses: actions/checkout@v2

       - run: mkdir -p logs/

       - uses: jpetrucciani/bandit-check@master
         with: 
           path: '.'
           bandit_flags: '-ll -o logs/bandit.log -f txt'

       - uses: actions/upload-artifact@v2
         with: 
          name: logs
          path: logs/bandit.log

   image-scan:
     needs: [build]
     runs-on: ubuntu-latest

     steps: 
       - uses: actions/checkout@v2

       - name: Build docker-compose
         run: docker-compose -f docker-compose.yml up --build -d

       - name: Check imgages
         run: docker images

       - name: Run Trivy scan on app
         uses: aquasecurity/trivy-action@master
         with:
          image-ref: '2022-group5-dvpwa_sqli'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

       - name: Run Trivy scan on db
         uses: aquasecurity/trivy-action@master
         with:
          image-ref: '2022-group5-dvpwa_postgres'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

   dast:
     needs: [build]
     runs-on: ubuntu-latest

     steps:
      - uses: actions/checkout@v2

      - name: Build docker-compose
        run: docker-compose -f docker-compose.yml up --build -d

      - name: ZAP Scan
        uses: zaproxy/action-full-scan@v0.3.0
        with:
          target: 'http://localhost:8080'
          cmd_options: '-a'

